<html>
	<head>
		<title>BubbleBase -- a Firebase demo game</title>
		<script src="https://code.createjs.com/easeljs-0.8.2.min.js"></script>
		<script src="https://code.createjs.com/tweenjs-0.6.2.min.js"></script>
		<script src="https://www.gstatic.com/firebasejs/3.7.0/firebase.js"></script>
		<script>
			// Initialize Firebase
			var config = {
				apiKey: "AIzaSyBqCKqeT2f73mTsJZoKZ2EORRLWcUSG8dI",
				authDomain: "bubblebase-f8da5.firebaseapp.com",
				databaseURL: "https://bubblebase-f8da5.firebaseio.com",
				storageBucket: "bubblebase-f8da5.appspot.com",
				messagingSenderId: "654534084811"
			};
			firebase.initializeApp(config);
		</script>

		<style>
		html, body {
			overflow: hidden;
		}
		</style>
		<script>
		db = firebase.database();
		food = {};
		foodPopulated = false;
		foodTimer = 0;

		function init() {
			stage = new createjs.Stage("gameCanvas");
			stage.canvas.width = window.innerWidth;
			stage.canvas.height = window.innerHeight;

			character = createCircle(100, 100, 20);
			stage.addChild(character);
			
			console.log('hi');
			console.log(food);

			createjs.Ticker.setFPS(30);
			createjs.Ticker.addEventListener("tick", tick);
		}

		function tick() {
			// update character position
			db.ref('players/me').update({
				x: character.x + character.vx,
				y: character.y + character.vy
			});

			// check for intersection between character and food
			for (var f in food) {
				console.log(food[f].visible);
				if (food[f].visible) {
					var a = character.x - food[f].x;
					var b = character.y - food[f].y;
					var c = Math.sqrt(a*a + b*b);
					console.log(c);
					if (c <= character.radius + food[f].radius) {
						updateCircleRadius(character, character.radius+10);
						db.ref('food/' + f + '').update({
							visible: false
						});
					}
				}
			}



			// generate new food
			/*
			if (foodTimer <= 0) {
				var newFood = createCircle(Math.random()*window.innerWidth, Math.random()*window.innerHeight, 10);
				stage.addChild(newFood);
				db.ref('food/' + numFood).update({
					x: newFood.x,
					y: newFood.y
				});

				// reset food timer
				foodTimer = Math.random()*200 + Math.random()*100;
				console.log("next food to appear in " + foodTimer);
			}
			foodTimer--;
			*/

			stage.update();
		}

		function createCircle(x, y, radius) {
			var newCircle = new createjs.Shape();
			newCircle.graphics.beginFill("DeepSkyBlue").drawCircle(0, 0, radius);
			newCircle.x = x;
			newCircle.y = y;
			newCircle.vx = 0;
			newCircle.vy = 0;
			newCircle.radius = radius;
			return newCircle;
		}

		function updateCircleRadius(circle, radius) {
			circle.graphics.clear();
			circle.graphics.beginFill("DeepSkyBlue").drawCircle(0, 0, radius);
			circle.radius = radius;
		}

		function deleteCircle(circle) {
			circle.graphics.clear();
			circle.x = -1000;
			circle.y = -1000;
			circle.radius = 0;
		}

		document.onkeydown = function (e) {
			e = e || window.event;

			if (e.keyCode == "38") { 	character.vy = -10;	} // up
			else if (e.keyCode == "40") {	character.vy = 10;		} //down
			else if (e.keyCode == "37") {	character.vx = -10;	} // left
			else if (e.keyCode == "39") {	character.vx = 10;		} // right
		}
		document.onkeyup = function (e) {
			e = e || window.event;

			if (e.keyCode == "38") {	character.vy = 0;	} // up
			else if (e.keyCode == "40") {	character.vy = 0;	} // down
			else if (e.keyCode == "37") {	character.vx = 0;	} // left
			else if (e.keyCode == "39") {	character.vx = 0;	} // right
		}

		db.ref('players').on('value', function(snapshot) {
			character.x = parseInt(snapshot.val().me.x);
			character.y = parseInt(snapshot.val().me.y);
		});
		db.ref('food').on('value', function(snapshot) {
			if (!foodPopulated) {
				for (var f in snapshot.val()) {
					food[f] = createCircle(snapshot.val()[f]['x'], snapshot.val()[f]['y'], 10);
					stage.addChild(food[f]);
					if (!snapshot.val()[f]['visible']) {
						deleteCircle(food[f]);
					}
				}
				foodPopulated = true;
			} else {
				for (var f in snapshot.val()) {
					if (snapshot.val()[f]['visible']) {
						food[f].x = snapshot.val()[f]['x'];
						food[f].y = snapshot.val()[f]['y'];
					} else {
						deleteCircle(food[f]);
					}
				}
			}
		})
		</script>
	</head>

	<body onload="init();">
		<canvas id="gameCanvas" width="500" height="300"></canvas>
	</body>
</html>